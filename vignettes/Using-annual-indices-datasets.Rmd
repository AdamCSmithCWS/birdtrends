---
title: "Use annual indices and uncertaintly to estimate trends over time"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use Annual indices and uncertaintly to estimate trends over time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


We can use the `birdtrends` package to model trends overtime based on annual indices datasets. These include information on year of data, index, and some form of uncertainty. 

Note: this vignette assumes you had already followed the steps outlined [here](https://ninoxconsulting.github.io/birdtrends/articles/Getting_started.html)

Lets start by loading all the libraries required.

```{r setup, warning = FALSE, message =FALSE}
#devtools::load_all()
library(birdtrends)
library(mgcv)
library(dplyr)
library(tidyr)

```


## Modelling trends based on annual indices. 

In many cases, we may not have access to the breadth of information retained in estimating the original modeled annual indices. 

An example dataset is provided within this package. This is an annual estimate on the Pacific Wren (" "), generated using the [bbsBayes2](https://bbsbayes.github.io/bbsBayes2/) package. This data was kindly provided by A.C. Smith. 

```{r}

head(annual_indicies_data)

```

In this example dataset we have an annual index from 1968 to 2022, along with confidence intervals of 2.5% and 97.5%. 

We can fit a hierarchical Bayesian General Additive Model (HGAM) to estimate the overall trend for the species over all years, or a specific date range. 


```{r run_hgam, warning = FALSE, message =FALSE}

indat1 <- annual_indicies_data

# fit the Heirachial GAM model 
fitted_data <- fit_hgam(indat1, start_yr = NA, end_yr = NA, n_knots = 5)

```


Select a subset of all the fitted HGAM models and reformat to long format. 
In this example we selected 100 rows for simplicity. 


```{r}

sel_hgams <- fitted_data %>%
  dplyr::slice_sample(., n = 100) %>%  
  dplyr::mutate(draw = seq(1, 100, 1)) %>% 
  tidyr::pivot_longer(., cols = !starts_with("d")) |> 
  dplyr::mutate(yearn = as.integer(name) - min(as.integer(name)))
         

```

We can reformat our original data to use in the plot 

```{r}
indat1 <- indat1 |> 
  dplyr::mutate(yearn = as.integer(year) - min(as.integer(year)))  

```

Now we can plot the predicted posterior distributions of 100 draws, along with the raw annual indices data provided. 

```{r}
comp_plot <- ggplot2::ggplot(data = sel_hgams,
                    ggplot2::aes(x = yearn,y = value,
                        group = draw, colour = draw))+
  ggplot2::geom_pointrange(data = indat1,
                  ggplot2::aes(x = yearn, y = index,
                      ymin = index_q_0.025,
                      ymax = index_q_0.975),
                  inherit.aes = FALSE,
                  alpha = 0.3)+
  ggplot2::geom_line(alpha = 0.3)+
  ggplot2::scale_colour_viridis_c() +
  ggplot2::scale_y_continuous(trans = "log10")+
  ggplot2::theme_bw()

```

```{r, fig.width=5, fig.height= 5}
comp_plot

```

